#!/usr/bin/env bash

set -e

PORT=3001

echo "🧪 Preparing test database..."
RAILS_ENV=test bin/rails db:test:prepare

echo "🔧 Starting Rails server on port $PORT in test environment..."
RAILS_ENV=test bin/rails server -p $PORT &
RAILS_PID=$!

echo "🔧 Starting Sidekiq in test environment..."
RAILS_ENV=test bundle exec sidekiq &
SIDEKIQ_PID=$!

echo "⏳ Waiting for Rails server to respond..."
for i in {1..20}; do
  if curl -s http://localhost:$PORT > /dev/null; then
    echo "✅ Rails server is up on port $PORT!"
    break
  fi
  sleep 0.5
done

if ! kill -0 "$RAILS_PID" 2>/dev/null; then
  echo "❌ Rails server failed to start. See /tmp/rails-test.log for details."
  kill "$SIDEKIQ_PID" 2>/dev/null || true
  exit 1
fi

if ! kill -0 "$SIDEKIQ_PID" 2>/dev/null; then
  echo "❌ Sidekiq failed to start. See /tmp/sidekiq-test.log for details."
  kill "$RAILS_PID" 2>/dev/null || true
  exit 1
fi

echo "🎭 Running Playwright..."
npx playwright test --config=e2e/playwright.config.js --ui"$@"

echo "🧹 Stopping Rails server and Sidekiq..."
kill "$RAILS_PID" "$SIDEKIQ_PID"
wait "$RAILS_PID" "$SIDEKIQ_PID" 2>/dev/null

echo "✅ Done."
