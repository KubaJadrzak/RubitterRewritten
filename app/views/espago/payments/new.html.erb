<div data-controller="payment-method espago-iframe" class="container" style="max-width: 480px; margin: 40px auto;">
  <div class="card shadow-sm p-4">
    <h3 class="mb-4 text-center">Choose Payment Method</h3>
    <% if @parent %>
      <p class="mb-4 text-center">
        You are about to pay <strong><%= number_to_currency(@parent.amount) %></strong>
      </p>
    <% end %>
    <%= form_with url: espago_start_payment_path, method: :post, data: { turbo: false }, html: { data: { payment_method_target: "form", espago_iframe_target: "form" }, id: "payment_form" } do |form| %>
      <%= hidden_field_tag :parent_type, @parent.class.name %>
      <%= hidden_field_tag :parent_id, @parent.id %>
      <% if current_user.clients.any? %>
        <div class="mb-3">
          <label class="form-label">Use Saved Card</label>
          <% current_user.clients.cit.each do |client| %>
            <div class="form-check">
              <%= radio_button_tag :client_id, client.id, false,
                  class: "form-check-input",
                  id: "client_#{client.id}",
                  data: { payment_method_target: "savedCard", action: "change->payment-method#updateSavedCard" } %>
              <label class="form-check-label" for="client_<%= client.id %>">
                **** **** **** <%= client.last4 %> (Exp: <%= client.month %>/<%= client.year %>)
              </label>
            </div>
          <% end %>
          <div class="form-check">
            <%= radio_button_tag :client_id, "", true,
                class: "form-check-input",
                id: "client_none",
                data: { payment_method_target: "savedCard", action: "change->payment-method#updateSavedCard" } %>
            <label class="form-check-label" for="client_none">Use a new card</label>
          </div>
        </div>
      <% end %>
      <div class="mb-3" data-payment-method-target="radioGroup">
        <label class="form-label">Payment Method</label>
        <div class="form-check">
          <input class="form-check-input" type="radio" id="one_time_option" name="payment_mode" value="one_time" checked data-payment-method-target="radio">
          <label class="form-check-label" for="one_time_option">One-time Payment</label>
        </div>
        <div class="form-check">
          <input class="form-check-input" type="radio" id="secure_option" name="payment_mode" value="secure_web_page" data-payment-method-target="radio">
          <label class="form-check-label" for="secure_option">Secure Web Page</label>
        </div>
      </div>
      <div class="form-check mb-3" data-payment-method-target="saveCardCheckbox">
        <%= check_box_tag :cof, 'storing', false, class: "form-check-input", id: "save_card" %>
        <label class="form-check-label" for="save_card">
          Save card information for future payments
        </label>
      </div>
      <%= form.submit "Process Payment", class: "btn btn-success d-none", data: { payment_method_target: "processBtn", espago_iframe_target: "processBtn", turbo: false } %>
    <% end %>
    <div class="d-grid mt-3">
      <a id="pay_btn" class="btn btn-primary btn-lg" data-payment-method-target="payBtn" style="cursor: pointer;">Pay</a>
      <button id="secure_web_page_btn" class="btn btn-primary btn-lg d-none mt-2" data-payment-method-target="secureBtn">Pay</button>
    </div>
    <p class="text-center text-muted mb-0" style="font-size: 0.9rem;">
      Payments provided by Espago
    </p>
  </div>
</div>
<script src="https://js.espago.com/espago-1.3.js"></script>
<script
  async
  data-id="EspagoFrameScript"
  data-key="<%= @espago_public_key %>"
  data-live="false"
  data-button="Pay"
  data-success="espagoCallback"
  src="https://js.espago.com/iframe.js"></script>
