<div data-controller="payment-method espago-iframe" class="container" style="max-width: 480px; margin: 40px auto;">
  <div class="card shadow-sm p-4">
    <h3 class="mb-4 text-center">Choose Payment Method</h3>
    <% if @parent %>
      <h5 class="mb-4 text-center">
        You are about to pay <strong><%= number_to_currency(@parent.amount) %></strong>
      </h5>
    <% end %>
    <%= form_with url: espago_start_payment_path, method: :post, data: { turbo: false }, html: { data: { payment_method_target: "form", espago_iframe_target: "form" }, id: "payment_form" } do |form| %>
      <%= hidden_field_tag :parent_type, @parent.class.name %>
      <%= hidden_field_tag :parent_id, @parent.id %>
      <fieldset class="mb-4 border rounded p-3">
        <div class="mb-3" data-payment-method-target="radioGroup">
          <% if current_user.clients.any? %>
            <h6 class="mb-3">Use saved card</h6>
            <% current_user.clients.cit.each do |client| %>
              <div class="form-check mb-2">
                <input class="form-check-input"
                 type="radio"
                 id="<%= client.client_id %>"
                 name="payment_mode"
                 value="<%= client.client_id %>"
                 data-payment-method-target="radio">
                <label class="form-check-label" for="<%= client.client_id %>">
                  <span class="d-inline-block fw-medium">•••• <%= client.last4 %></span>
                  <small class="text-muted ms-1">(Exp: <%= client.month %>/<%= client.year %>)</small>
                </label>
              </div>
            <% end %>
          <% end %>
          <h6 class="mb-3 mt-4">Use new card</h6>
          <div class="form-check mb-2">
            <input class="form-check-input"
             type="radio"
             id="new_one_time_option"
             name="payment_mode"
             value="new_one_time"
             <%= "checked" if current_user.clients.empty? %>
             data-payment-method-target="radio">
            <label class="form-check-label" for="new_one_time_option">One-time Payment</label>
          </div>
          <div class="form-check mb-2">
            <input class="form-check-input"
             type="radio"
             id="new_secure_option"
             name="payment_mode"
             value="new_secure_web_page"
             data-payment-method-target="radio">
            <label class="form-check-label" for="new_secure_option">Secure Web Page</label>
          </div>
        </div>
        <div class="form-check mb-0" data-payment-method-target="saveCardCheckbox">
          <div class="border-top mt-3 pt-3">
            <%= check_box_tag :cof, 'storing', false, class: "form-check-input", id: "save_card" %>
            <label class="form-check-label" for="save_card">
              Save card information for future payments
            </label>
          </div>
        </div>
      </fieldset>
      <%= form.submit "Process Payment", class: "btn btn-success d-none", data: { payment_method_target: "processBtn", espago_iframe_target: "processBtn", turbo: false } %>
    <% end %>
    <div class="d-grid mt-3">
      <a id="pay_btn" class="btn btn-primary btn-lg" data-payment-method-target="payBtn" style="cursor: pointer;">Pay</a>
      <button id="secure_web_page_btn" class="btn btn-primary btn-lg d-none mt-2" data-payment-method-target="secureBtn">Pay</button>
    </div>
    <p class="text-center text-muted mb-0" style="font-size: 0.9rem;">
      Payments provided by Espago
    </p>
  </div>
</div>
<script src="https://js.espago.com/espago-1.3.js"></script>
<script
  async
  data-id="EspagoFrameScript"
  data-key="<%= @espago_public_key %>"
  data-live="false"
  data-button="Pay"
  data-success="espagoCallback"
  src="https://js.espago.com/iframe.js"></script>
